var test = require('tape')

var OTAUtil = require('../ota_util')

function format(value){
  return OTAUtil.swapEndian(value).toString(16).toUpperCase()
}

test('Swap Endianess', function(t){
  t.plan(1)
  t.equal(0xAABB, OTAUtil.swapEndian(0xBBAA))
})

test('Summation CheckSum', function (t) {
  t.plan(6)

  //Samples from debugging the cypress app
  //Enter Bootloader Command
  var value = OTAUtil.calculateCheckSum(0,[0x01, 0x38, 0x00, 0x00])
  t.equal("C7FF", format(value), "Checksum should be correct for Enter Bootloader Command")

  //Get Flash size Command
  value = OTAUtil.calculateCheckSum(0,[0x01, 0x32, 0x01, 0x00, 0x01])
  t.equal("CBFF", format(value), "Checksum should be correct for Get Flash Size Command")

  //Verify Checksum Command
  value = OTAUtil.calculateCheckSum(0,[0x01, 0x31, 0x00, 0x00])
  t.equal("CEFF", format(value), "Checksum should be correct for Verify Checksum Command")

  //Exit Bootloader Command
  value = OTAUtil.calculateCheckSum(0,[0x01, 0x3B, 0x00, 0x00])
  t.equal("C4FF", format(value), "Checksum should be correct for Exit Bootloader Command")

  //OTAProgramRowCmd
  var programRowData = [0x01, 0x39, 0x83, 0x00, 0x01, 0xD5, 0x00, 0x00, 0x40, 0x00, 0x20, 0x91, 0x6A, 0x01, 0x00, 0xF1, 0xCB, 0x01, 0x00, 0xF1, 0xCB, 0x01, 0x00, 0x80, 0xB5, 0x00, 0xAF, 0x02, 0x4B, 0x83, 0xF3, 0x08, 0x88, 0x06, 0xF0, 0xDB, 0xF8, 0xC0, 0x46, 0x00, 0x40, 0x00, 0x20, 0x80, 0xB5, 0x00, 0xAF, 0x37, 0x4B, 0x12, 0x22, 0x1A, 0x60, 0x07, 0xF0, 0x3F, 0xFD, 0x36, 0x4B, 0x18, 0x00, 0x07, 0xF0, 0x77, 0xFF, 0x01, 0x20, 0x07, 0xF0, 0x48, 0xFD, 0x30, 0x20, 0x07, 0xF0, 0x53, 0xFB, 0x32, 0x4B, 0x32, 0x4A, 0x1A, 0x60, 0x32, 0x4B, 0x80, 0x22, 0xD2, 0x05, 0x1A, 0x60, 0x31, 0x4B, 0x31, 0x4A, 0x12, 0x68, 0x02, 0x21, 0x0A, 0x43, 0x1A, 0x60, 0x2F, 0x4B, 0x30, 0x4A, 0x1A, 0x60, 0x30, 0x4B, 0x00, 0x22, 0x1A, 0x60, 0x2F, 0x4B, 0x2F, 0x4A, 0x12, 0x68, 0x08, 0x21, 0x8A, 0x43, 0x1A, 0x60, 0xFA, 0x23, 0xDB, 0x00, 0x18, 0x00, 0x07, 0xF0]
  value = OTAUtil.calculateCheckSum(0, programRowData)
  t.equal("4BD5", format(value), "Checksum should be correct for OTAProgramRowCmd")

  //OTAVerifyRowCmd
  value = OTAUtil.calculateCheckSum(0,[0x01, 0x3A, 0x03, 0x00, 0x01, 0xD5, 0x00])
  t.equal("ECFE", format(value), "Checksum should be correct for Exit Bootloader Command")

})
